<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta http-equiv="X-UA-Compatible" content="IE=edge">

<title>WAVLab | TIR Usage</title>
<meta name="description" content="Webpage of Watanabe's Audio and Voice (WAV) Lab
">

<!-- Open Graph -->


<!-- Bootstrap & MDB -->
<link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet" integrity="sha512-MoRNloxbStBcD8z3M/2BmnT+rg4IsMxPkXaGh2zD6LGNNFE80W3onsAhRcMAMrSoyWL9xD7Ert0men7vR8LUZg==" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/mdbootstrap/4.19.1/css/mdb.min.css" integrity="sha512-RO38pBRxYH3SoOprtPTD86JFOclM51/XTIdEPh5j8sj4tp8jmQIx26twG52UaLi//hQldfrh7e51WzP9wuP32Q==" crossorigin="anonymous" />

<!-- Fonts & Icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css"  integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog==" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/academicons/1.9.0/css/academicons.min.css" integrity="sha512-W4yqoT1+8NLkinBLBZko+dFB2ZbHsYLDdr50VElllRcNt2Q4/GSs6u71UHKxB7S6JEMCp5Ve4xjh3eGQl/HRvg==" crossorigin="anonymous">
<link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons">

<!-- Code Syntax Highlighting -->
<link rel="stylesheet" href="https://raw.githubusercontent.com/repo/jwarby/jekyll-pygments-themes/master/github.css" />

<!-- Styles -->

<link rel="icon" href="/assets/img/favicon.png">

<link rel="stylesheet" href="/assets/css/main.css">

<link rel="canonical" href="/activities/2022/tir-usage/">

<!-- JQuery -->
<!-- jQuery -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>


<!-- Theming-->

  <script src="/assets/js/theme.js"></script>
  <!-- Load DarkMode JS -->
<script src="/assets/js/dark_mode.js"></script>






    
<!-- MathJax -->
<script type="text/javascript">
  window.MathJax = {
    tex: {
      tags: 'ams'
    }
  };
</script>
<script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.1.2/es5/tex-mml-chtml.js"></script>
<script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>


  </head>

  <body class="fixed-top-nav ">

    <!-- Header -->

    <header>

    <!-- Nav Bar -->
    <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top">
    <div class="container">
      
      <a class="navbar-brand title font-weight-lighter" href="/">
       WAVLab
      </a>
      
      <!-- Navbar Toggle -->
      <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar top-bar"></span>
        <span class="icon-bar middle-bar"></span>
        <span class="icon-bar bottom-bar"></span>
      </button>
      <div class="collapse navbar-collapse text-right" id="navbarNav">
        <ul class="navbar-nav ml-auto flex-nowrap">
          <!-- About -->
          <li class="nav-item ">
            <a class="nav-link" href="/">
              About
              
            </a>
          </li>
          <!-- Blog -->
          <li class="nav-item ">
            <a class="nav-link" href="/blog/">
              Activities
              
            </a>
          </li>
          <!-- Other pages -->
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          <li class="nav-item ">
              <a class="nav-link" href="/members/">
                Members
                
              </a>
          </li>
          
          
          
          <li class="nav-item ">
              <a class="nav-link" href="/publications/">
                Publications
                
              </a>
          </li>
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          <li class="nav-item ">
              <a class="nav-link" href="/open_source">
                Open-source
                
              </a>
          </li>
          
          
          
          <li class="nav-item ">
              <a class="nav-link" href="/courses/">
                Courses
                
              </a>
          </li>
          
          
          
          <li class="nav-item ">
              <a class="nav-link" href="/sponsors/">
                Sponsors
                
              </a>
          </li>
          
          
          
          <li class="nav-item ">
              <a class="nav-link" href="/info/">
                Info
                
              </a>
          </li>
          
          
          
          <li class="nav-item ">
              <a class="nav-link" href="/positions/">
                Positions
                
              </a>
          </li>
          
          
          
          <li class="nav-item ">
              <a class="nav-link" href="/speech_lunch">
                Speech Lunch
                
              </a>
          </li>
          
          
          
          
            <div class = "toggle-container">
              <a id = "light-toggle">
                  <i class="fas fa-moon"></i>
                  <i class="fas fa-sun"></i>
              </a>
            </div>
          
        </ul>
      </div>
    </div>
  </nav>

</header>


    <!-- Content -->

    <div class="container mt-5">
      

<div class="post">

  <header class="post-header">
    <h1 class="post-title">TIR Usage</h1>
    <p class="post-meta">January 1, 2022</p>
  </header>

  <article class="post-content">
    <h1 id="installation">Installation</h1>

<h2 id="starting-a-bash-slurm-job">Starting a bash Slurm job</h2>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>srun <span class="nt">--pty</span> <span class="nt">-n</span> 1 <span class="nt">--cpus-per-task</span><span class="o">=</span>8  <span class="nt">--gres</span><span class="o">=</span>gpu:1 <span class="nt">--mem</span><span class="o">=</span>12G /bin/bash <span class="nt">-l</span>
</code></pre></div></div>

<h2 id="loading-required-modules">Loading Required Modules</h2>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>module load cuda-11.1.1 cudnn-11.1.1-v8.0.4.30 gcc-5.5.0
</code></pre></div></div>

<h2 id="miniconda-installation">Miniconda installation</h2>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh
   bash Miniconda3-latest-Linux-x86_64.sh
</code></pre></div></div>

<h2 id="installing-espnet--kaldi">Installing ESPnet &amp; Kaldi</h2>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd</span> &lt;path-to-your-projects&gt;
git clone https://github.com/espnet/espnet

<span class="nb">cd</span> &lt;espnet-root&gt;/tools/
git clone https://github.com/kaldi-asr/kaldi

<span class="c"># setup virtual environment (venv) for python</span>
<span class="nb">cd</span> &lt;espnet-root&gt;/tools/
./setup_venv.sh <span class="si">$(</span><span class="nb">command</span> <span class="nt">-v</span> python3<span class="si">)</span>
</code></pre></div></div>

<h3 id="building-kaldi">Building kaldi</h3>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd</span> &lt;espnet-root&gt;/tools/
<span class="nb">.</span> activate_python.sh
</code></pre></div></div>

<p>Check dependencies and install OpenBLAS (MKL and ATLAS installations need sudo privileges)</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd</span> &lt;kaldi-root&gt;/tools/
extras/check_dependencies.sh
make <span class="nt">-j</span> 8
./extras/install_openblas.sh
./extras/install_irstlm.sh

<span class="nb">cd</span> &lt;kaldi-root&gt;/src
<span class="c"># without CUDA (ESPnet uses only feature extractor, so you can disable CUDA)</span>
./configure <span class="nt">--openblas-root</span><span class="o">=</span>../tools/OpenBLAS/install <span class="nt">--use-cuda</span><span class="o">=</span>no
make <span class="nt">-j</span> clean depend<span class="p">;</span> make <span class="nt">-j</span> 8
</code></pre></div></div>

<h3 id="building-espnet">Building espnet</h3>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd</span> &lt;espnet-root&gt;/tools
make <span class="nt">-j</span> 8 <span class="nv">CUDA_VERSION</span><span class="o">=</span>11.1 <span class="nv">TH_VERSION</span><span class="o">=</span>1.8.1
</code></pre></div></div>

<h3 id="check-espnet--kaldi-installation">Check espnet + kaldi installation</h3>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd</span> &lt;espnet-root&gt;/egs/an4/asr1/
./run.sh
</code></pre></div></div>

<h2 id="exit-the-bash-slurm-job">Exit the bash Slurm job</h2>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">exit</span>
</code></pre></div></div>

<h2 id="misc">Misc.</h2>
<h3 id="installing-sox-manually-if-unable-to-install-via-conda">Installing sox manually (if unable to install via conda)</h3>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">mkdir</span> <span class="nt">-p</span> ~/rpm
<span class="nb">cd</span> ~/rpm
wget http://mirror.centos.org/centos/7/os/x86_64/Packages/sox-14.4.1-7.el7.x86_64.rpm
rpm2cpio ~/rpm/sox-14.4.1-7.el7.x86_64.rpm | cpio <span class="nt">-id</span>

<span class="nb">export </span><span class="nv">PATH</span><span class="o">=</span><span class="s2">"</span><span class="nv">$HOME</span><span class="s2">/rpm/usr/sbin:</span><span class="nv">$HOME</span><span class="s2">/rpm/usr/bin:</span><span class="nv">$HOME</span><span class="s2">/rpm/bin:</span><span class="nv">$PATH</span><span class="s2">"</span>
<span class="nv">L</span><span class="o">=</span><span class="s1">'/lib:/lib64:/usr/lib:/usr/lib64'</span>
<span class="nb">export </span><span class="nv">LD_LIBRARY_PATH</span><span class="o">=</span><span class="s2">"</span><span class="nv">$L</span><span class="s2">:</span><span class="nv">$HOME</span><span class="s2">/rpm/usr/lib:</span><span class="nv">$HOME</span><span class="s2">/rpm/usr/lib64"</span>
</code></pre></div></div>
<p>Note: You can also add the last 3 lines to your <code class="language-plaintext highlighter-rouge">~/.bashrc</code> file because connecting over ssh reads and executes commands from <code class="language-plaintext highlighter-rouge">~/.bashrc</code>.</p>

<h4 id="install-sox-from-scratch-with-flac-support-refer-to-this">Install Sox from scratch with flac support: refer to <a href="http://akshayc.com/blog/build-sox-from-scratch/">this</a>.</h4>

<h1 id="login">Login</h1>
<p>Simple <code class="language-plaintext highlighter-rouge">ssh</code> would be working:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ssh &lt;your_username&gt;@tir.lti.cs.cmu.edu
</code></pre></div></div>

<h1 id="usage-details">Usage details</h1>

<h2 id="general-guidelines">General guidelines</h2>
<p>There is a general document for tir usage at https://docs.google.com/document/d/1ieMgNos6F97XAtfD_m6WINte1gAQcPDqpqbbB82Rv4A/edit?usp=sharing</p>

<h2 id="data-storage">Data storage</h2>
<p>We have stored many databases in <code class="language-plaintext highlighter-rouge">/projects/tir5/data/speech_corpora</code>. Please look ahead at the directory before downloading on your own. In the same time, please add new databases there if you have any other needs.</p>

<h2 id="io-issues">IO issues</h2>
<p>The TIR may have IO issues when directly train models with data stored in storage node. One option to fix that is to shift the prepared features to the <code class="language-plaintext highlighter-rouge">/tmp/</code> and then run my training. After that delete related files from /tmp before exit.</p>

<h3 id="procedures-for-espnet1-would-like">Procedures for ESPNet1 would like:</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dumpdir=`mktemp -d /tmp/st-XXXX`    # directory to dump full features

feat_tr_dir=${dumpdir}/${train_set}/delta${do_delta}; mkdir -p ${feat_tr_dir}
feat_dt_dir=${dumpdir}/${train_dev}/delta${do_delta}; mkdir -p ${feat_dt_dir}
</code></pre></div></div>

<h3 id="procedures-for-espnet2-would-like">Procedures for ESPNet2 would like:</h3>
<p>In <code class="language-plaintext highlighter-rouge">run.sh</code>, set audio format to lower IO issues</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>--audio_format "flac.ark" \
</code></pre></div></div>

<p>At the start of the training stage (e.g., <code class="language-plaintext highlighter-rouge">asr.sh</code> stage 11), add:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>tempdir=$(mktemp -d "/tmp/&lt;your_projectname&gt;-$$.XXXXXXXX")
trap 'rm -rf ${tempdir}' EXIT
cp -r "${data_feats}" ${tempdir}
# or rsync -zav --progress --bwlimit=100 "${data_feats}" ${tempdir}
data_feats="${tempdir}/$(basename ${data_feats})"
scp_lists=$(find ${tempdir} -type f -name "*.scp")
for f in ${scp_lists}; do
    sed -i -e "s/${dumpdir//\//\\/}/${tempdir//\//\\/}/g" $f
done

</code></pre></div></div>

<p>At the end of <code class="language-plaintext highlighter-rouge">asr.sh</code>, add</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rm -rf ${tempdir}
</code></pre></div></div>

<p>As the tmp folder is corresponding to specifc compute node, please set the <code class="language-plaintext highlighter-rouge">cmd</code> as <code class="language-plaintext highlighter-rouge">local</code> and process <code class="language-plaintext highlighter-rouge">run.sh</code> with <code class="language-plaintext highlighter-rouge">sbatch</code></p>

<h3 id="other-option">Other option</h3>
<p>Since the <code class="language-plaintext highlighter-rouge">tmp</code> method depends on limited <code class="language-plaintext highlighter-rouge">tmp</code> storage and need to copy the data everytime, you can also copy all your environment to <code class="language-plaintext highlighter-rouge">/scratch/&lt;your_node_name&gt;</code> and execute your jobs only on that node by setting <code class="language-plaintext highlighter-rouge">--nodelist=&lt;your_node_name&gt;</code>.</p>

<h2 id="notes-for-running-multiple-gpus">Notes for running multiple GPUs</h2>
<p>When running jobs with multiple GPUs, you should submit jobs with arguments as <code class="language-plaintext highlighter-rouge">--mem Xgb --cpus-per-task Y --gres gpu:ngpus</code>. A simple rule would be like</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>X = 16 * ngpus or 4 * ncpus
Y = 5 * ngpus
</code></pre></div></div>

<h2 id="use-slurm-backend-for-espnet">Use slurm backend for ESPnet</h2>
<p>Because of the I/O issue, we would recommend you to submit jobs by <code class="language-plaintext highlighter-rouge">local</code> backend. But if you want to directly use the <code class="language-plaintext highlighter-rouge">slurm</code> backend, you can use the following config to replace the <code class="language-plaintext highlighter-rouge">conf/slurm.conf</code></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># Default configuration
command sbatch --export=PATH
option name=* --job-name $0
option time=* --time $0
option exclude=* --exclude $0
option mem=* --mem-per-cpu $0
option mem=0
option num_threads=* --cpus-per-task $0
option num_threads=1 --cpus-per-task 1
option num_nodes=* --nodes $0
default gpu=0
default mem=6000
# option gpu=0 -p cpu
option gpu=0
option gpu=* --gres=gpu:$0 -c $0  # Recommend allocating more CPU than, or equal to the number of GPU
</code></pre></div></div>

<p>Since tir does not have CPU-only machines and some CPU jobs may block some good GPUs instead of the worse ones, so in that case, please try to exclude some of the nodes by setting</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    export train_cmd="slurm.pl --mem 4000 --time 1-0:00:00 --exclude tir-0-19,tir-1-23,tir-1-28,tir-1-11,tir-1-7,tir-0-28,tir-0-3,tir-0-36,tir-0-32,tir-1-13,tir-1-18,tir-0-11"
    export cuda_cmd="slurm.pl --mem 6000 --time 3-0:00:00 --exclude tir-0-19,tir-1-23,tir-1-28,tir-1-11,tir-1-7,tir-0-28,tir-0-3,tir-0-36,tir-0-32,tir-1-13,tir-1-18,tir-0-11"
    export decode_cmd="slurm.pl --mem 8000 --time 1-0:00:00 --exclude tir-0-19,tir-1-23,tir-1-28,tir-1-11,tir-1-7,tir-0-28,tir-0-3,tir-0-36,tir-0-32,tir-1-13,tir-1-18,tir-0-11"
</code></pre></div></div>

  </article>

  

</div>

    </div>

    <!-- Footer -->

    
<footer class="fixed-bottom">
  <div class="container mt-0">
    &copy; Copyright 2025   WAV Lab.
    Powered by <a href="http://jekyllrb.com/" target="_blank">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank">GitHub Pages</a>.

    
    
  </div>
</footer>



  </body>

  <!-- Bootsrap & MDB scripts -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/2.4.4/umd/popper.min.js" integrity="sha512-eUQ9hGdLjBjY3F41CScH3UX+4JDSI9zXeroz7hJ+RteoCaY+GP/LDoM8AO+Pt+DRFw3nXqsjh9Zsts8hnYv8/A==" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js" integrity="sha512-M5KW3ztuIICmVIhjSqXe01oV2bpe248gOxqmlcYrEzAvws7Pw3z6BK0iGbrwvdrUQUhi3eXgtxp5I8PDo9YfjQ==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mdbootstrap/4.19.1/js/mdb.min.js" integrity="sha512-Mug9KHKmroQFMLm93zGrjhibM2z2Obg9l6qFG2qKjXEXkMp/VDkI4uju9m4QKPjWSwQ6O2qzZEnJDEeCw0Blcw==" crossorigin="anonymous"></script>

  
<!-- Mansory & imagesLoaded -->
<script defer src="https://unpkg.com/masonry-layout@4/dist/masonry.pkgd.min.js"></script>
<script defer src="https://unpkg.com/imagesloaded@4/imagesloaded.pkgd.min.js"></script>
<script defer src="/assets/js/mansory.js" type="text/javascript"></script>


  


<!-- Load Common JS -->
<script src="/assets/js/common.js"></script>


</html>
